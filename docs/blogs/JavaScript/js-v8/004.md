---
title: Node的回调函数机制
date: 2025-07-09
categories:
  - Nodejs
tags:
  - JavaScript
---


`回调函数`的方式内部利用了`发布-订阅`模式，这里模拟实现 node 中的 Event 模块为例来实现回调函数机制。

```js
function EventEmitter() {
    this.events = new Map();
}
```

这个 EventEmitter 一共要实现这些方法：`addListener`, `removeListener`, `once`, `removeAllListener`, `emit`。


**addListener：**

```js
const wrapCallback = (fn, once) => ({callback: fn, once});

EventEmitter.prototype.addListener = function(type, fn, once = false) {
    const handler = this.events.get(type);

    if (!handler) {
        this.events.set(type, wrapCallback(fn, once));
    }
    else if (handler && typeof handler.callback === 'function') {
        this.events.set(type, [handler, wrapCallback(fn, once)]);
    }
    else {
        handler.push(wrapCallback(fn, once));
    }
}
```

**removeListener:**

```js
EventEmitter.prototype.removeListener = function(type, listener) {
    const handler = this.events.get(type);
    if (!handler) {
        return;
    }
    if (!Array.isArray(handler)) {
        if (handler.callback === listener.callback) {
            this.events.delete(type);
        }
        else return;
    }
    for (let i = 0; i < handler.length; i++) {
        let item = handler[i];
        if (item.callback === listener.callback) {
            handler.splice(i, 1);
            i--;

            if (handler.length === 1) {
                this.events.set(type, handler[0]);
            }
        }
    }
}
```


**once**

```js
EventEmitter.prototype.once = function (type, fn) {
    this.addListener(type, fn, true);
}
```

**emit**

```js
EventEmitter.prototype.emit = function (type, ...args) {
    const handler = this.events.get(type);
    if (!handler) {
        return;
    }
    if (Array.isArray(handler)) {
        handler.map(item => {
            item.callback.apply(this, ...args);
            if (item.once) {
                this.removeListener(type, item);
            }
        })
    }
    else {
        handler.callback.apply(this, ...args);
    }
    return true;
}

```

**removeAllListener**

```js
EventEmitter.prototype.removeAllListener = function() {
    const handler = this.events.get(type);
    if (!handler) {
        return;
    }
    this.events.delete(type);
}
```